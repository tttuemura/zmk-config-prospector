# Prospector Scanner v2.0.0 "Touch & Precision"

**Release Date**: November 20, 2025
**Status**: ‚úÖ **Production Ready** - Major Feature Release
**Version Type**: Major version with touch support and architectural improvements

## üåü Release Highlights

v2.0.0 represents a **fundamental evolution** of Prospector Scanner with optional touch panel support, improved USB connection detection, and enhanced stability through comprehensive thread-safety improvements.

### üèÜ **Major New Features**

#### **1. Touch Panel Support** üéØ *Optional Feature*
- **CST816S Integration**: Full support for Waveshare 1.69" Round LCD touch variant
- **Gesture Recognition**: Four-direction swipe gestures (Up/Down/Left/Right)
- **Display Settings Screen**: Touch-activated settings interface (DOWN swipe)
- **Dual Build Modes**: Separate touch/non-touch firmware configurations
- **Zero Overhead**: Non-touch builds exclude all touch code completely

**Related GitHub Issues**: #1 (Touch panel integration)

#### **2. USB Connection Display Fix** üîå
- **Accurate Connection Status**: Shows "> USB" when keyboard is USB-connected
- **Protocol-Based Detection**: Uses `USB_HID_READY` flag from status advertisement
- **Real-time Updates**: Immediate response to connection state changes
- **BLE Profile Display**: Maintains BLE profile information alongside USB status

**Related GitHub Issues**: #5 (USB connection display)

#### **3. Timeout Brightness Control** ‚è±Ô∏è
- **Configurable Timeout**: Dims display to 5% after no keyboard reception
- **Automatic Recovery**: Restores brightness when keyboard data received
- **Universal Operation**: Works with both USB and battery power
- **Disable Support**: Setting timeout to 0 disables the feature

#### **4. Signal Status Stabilization** üìä
- **1Hz Periodic Updates**: Consistent update frequency for reception strength
- **Stable Display**: Eliminates irregular update intervals
- **Accurate Metrics**: Real-time RSSI and reception rate display

### üèóÔ∏è **Architecture Improvements**

#### **Thread-Safety Enhancements** üîí
- **LVGL Mutex Protection**: All LVGL operations properly synchronized
- **ZMK Event System**: Touch gestures use event system for thread safety
- **Work Queue Safety**: Prevents concurrent access to shared resources
- **Freeze Elimination**: Complete resolution of random freeze issues

**Background**: Previous versions experienced random freezes during screen transitions or multi-keyboard scanning due to race conditions between LVGL timer, work queues, and touch input threads.

#### **Dynamic Memory Allocation** üíæ
- **On-Demand Widget Creation**: UI components allocated when screens shown
- **Memory Efficiency**: Only active screens consume memory
- **Clean Lifecycle**: Proper widget destruction when switching screens
- **LVGL Input Timing**: Input devices registered after widget creation

#### **Conditional Compilation** üîß
- **Touch/Non-Touch Separation**: Clear build-time mode selection
- **Code Elimination**: Touch code completely excluded in non-touch builds
- **Kconfig Control**: `CONFIG_PROSPECTOR_TOUCH_ENABLED` for mode selection
- **Smaller Binaries**: Non-touch builds maintain smaller size

### üåê **Sensor Improvements**

#### **APDS9960 4-Pin Connection Support** üîÜ
- **Direct I2C Implementation**: Bypasses Zephyr driver blocking issues
- **No Interrupt Required**: Works with 4-pin connection (VCC/GND/SDA/SCL)
- **Reliable Operation**: Eliminates sensor blocking on `sensor_sample_fetch()`
- **Polling Mode**: Efficient I2C register polling for ambient light data

**Background**: v1.1 users reported sensor freezing due to Zephyr APDS9960 driver using `k_sem_take(K_FOREVER)` that never returned without interrupt pin connected.

## üìä Version Comparison

| Feature | v1.1.1 | v2.0.0 | Improvement |
|---------|--------|--------|-------------|
| **Touch Panel** | Not supported | CST816S with gestures | ‚úÖ New feature |
| **USB Detection** | Always shows "BLE" | Correct "USB" display | ‚úÖ Accurate status |
| **Thread Safety** | Race conditions | Mutex + events | ‚úÖ Freeze-free |
| **Timeout Dimming** | Not supported | Configurable 5% dim | ‚úÖ Battery savings |
| **Signal Updates** | Irregular | Stable 1Hz | ‚úÖ Consistent display |
| **APDS9960 Pins** | 5-pin required | 4-pin supported | ‚úÖ Simplified wiring |
| **Memory Model** | Static allocation | Dynamic allocation | ‚úÖ Efficient usage |
| **Build Modes** | Single mode | Touch/non-touch | ‚úÖ User choice |

## üîß Bug Fixes & Improvements

### **Display & UI**
1. ‚úÖ **USB Connection Display** (Issue #5): Fixed connection status widget to show "> USB" when keyboard is USB-connected
2. ‚úÖ **Signal Widget Updates**: Implemented stable 1Hz periodic update for reception strength display
3. ‚úÖ **Timeout Brightness**: Added configurable timeout with 5% dim and automatic recovery

### **Hardware & Sensors**
1. ‚úÖ **APDS9960 Blocking** (Issue from v1.1): Direct I2C implementation eliminates driver blocking on 4-pin connections
2. ‚úÖ **Touch Panel Integration** (Issue #1): Full CST816S support with gesture recognition and event system

### **Stability & Thread Safety**
1. ‚úÖ **Random Freezes**: LVGL mutex protection prevents deadlocks during screen transitions
2. ‚úÖ **Touch Deadlock**: ZMK event system eliminates race conditions in swipe handling
3. ‚úÖ **Work Queue Conflicts**: Swipe handler stops periodic work during transitions
4. ‚úÖ **Input Timing**: LVGL input devices registered after widget creation

### **Configuration & Build**
1. ‚úÖ **Touch Mode Selection**: Clear Kconfig option for touch/non-touch builds
2. ‚úÖ **Code Elimination**: Touch code completely excluded when disabled
3. ‚úÖ **Font Configuration**: Proper LVGL font enablement for all widgets

## üõ†Ô∏è Hardware Requirements

### Scanner Device (Both Modes)
- **MCU**: Seeeduino XIAO BLE (nRF52840)
- **Display**: Waveshare 1.69" Round LCD (ST7789V, 240x280)
- **Optional**: APDS9960 ambient light sensor (4-pin connection supported)
- **Optional**: LiPo battery for portable operation

### Touch Mode Additional Requirements
- **Display**: Waveshare 1.69" Round LCD **with CST816S touch panel**
- **Connections**: Touch panel shares I2C bus (D4/D5) with APDS9960
  - TP_IRQ ‚Üí D0 (P0.02)
  - TP_RST ‚Üí D1 (P0.28)

### Non-Touch Mode
- **Display**: Any Waveshare 1.69" Round LCD (with or without touch panel)
- **Simpler Wiring**: No touch connections required
- **Smaller Firmware**: Reduced code size without touch support

## üìã Configuration Guide

### Touch Mode Build

**File**: `config/prospector_scanner_touch.conf`

```conf
# Enable touch panel support
CONFIG_PROSPECTOR_TOUCH_ENABLED=y

# Touch panel dependencies (auto-enabled)
CONFIG_INPUT=y
CONFIG_INPUT_CST816S=y
CONFIG_INPUT_CST816S_INTERRUPT=y
```

**Build Command**:
```bash
west build -b seeeduino_xiao_ble -s zmk/app -- \
  -DSHIELD=prospector_scanner \
  -DZMK_CONFIG="/path/to/config" \
  -DZMK_EXTRA_MODULES="/path/to/prospector-zmk-module"
```

### Non-Touch Mode Build

**File**: `config/prospector_scanner.conf`

```conf
# Disable touch panel support (default)
CONFIG_PROSPECTOR_TOUCH_ENABLED=n

# All touch code excluded at compile time
```

### Timeout Brightness Configuration

```conf
# Timeout settings (both modes)
CONFIG_PROSPECTOR_SCANNER_TIMEOUT_MS=480000  # 8 minutes (0 = disabled)
CONFIG_PROSPECTOR_SCANNER_TIMEOUT_BRIGHTNESS=5  # 5% during timeout
```

## üîÑ Migration Guide

### **From v1.1.1 ‚Üí v2.0.0**

#### **1. Update Module Reference**

Edit `config/west.yml`:
```yaml
- name: prospector-zmk-module
  remote: prospector
  revision: v2.0.0  # Update from v1.1.1
  path: modules/prospector-zmk-module
```

#### **2. Choose Build Mode**

**For Non-Touch (Standard)**:
- Use `config/prospector_scanner.conf` (no changes needed)
- Touch code automatically excluded
- Existing wiring works as-is

**For Touch Mode**:
- Use `config/prospector_scanner_touch.conf`
- Add touch panel wiring (TP_IRQ ‚Üí D0, TP_RST ‚Üí D1)
- Enable touch configuration: `CONFIG_PROSPECTOR_TOUCH_ENABLED=y`

#### **3. Update Keyboard Firmware** (Optional but Recommended)

To enable USB connection display, ensure your keyboard firmware includes:
```conf
CONFIG_ZMK_STATUS_ADVERTISEMENT=y
CONFIG_ZMK_STATUS_ADV_KEYBOARD_NAME="YourKeyboard"
```

The protocol already includes USB status - scanner v2.0 just displays it correctly.

#### **4. Optional: Add Timeout Brightness**

Add to `prospector_scanner.conf`:
```conf
CONFIG_PROSPECTOR_SCANNER_TIMEOUT_MS=480000  # 8 minutes
CONFIG_PROSPECTOR_SCANNER_TIMEOUT_BRIGHTNESS=5
```

#### **5. APDS9960 Users** (If Using Sensor)

v2.0 supports 4-pin connection - you can remove interrupt pin if using 5-pin wiring:
- **Required**: VCC, GND, SDA (D4), SCL (D5)
- **Not needed**: INT pin (polling mode)

No configuration changes needed - direct I2C works automatically.

## üöÄ New in v2.0 Development

### Touch Features (Touch Mode Only)

#### **Gesture System**
- **DOWN Swipe**: Open Display Settings screen
- **UP Swipe**: Return to main display
- **LEFT/RIGHT**: Reserved for future features

#### **Display Settings Screen**
- **Max Layers Setting**: Adjust visible layer count (4-10)
- **Interactive Sliders**: Touch-based value adjustment
- **Real-time Preview**: Main screen updates immediately
- **Navigation**: UP swipe to return

### Event System Integration

Touch gestures use ZMK event system for thread safety:
```c
// Touch handler raises event from IRQ context (thread-safe)
raise_zmk_swipe_gesture_event(...);

// Scanner display listens in main thread (safe LVGL calls)
ZMK_LISTENER(swipe_gesture, swipe_gesture_listener);
```

This pattern eliminates race conditions that caused freezes in earlier implementations.

## üìö Documentation

### Main Documentation
- **README.md**: Overview and quick start guide
- **SCANNER_RECONSTRUCTION_DESIGN.md**: Architecture and design principles (local development file)

### Release Documentation
- **docs/RELEASES.md**: All release notes index
- **docs/RELEASES/v2.0.0.md**: This document
- **docs/TOUCH_MODE.md**: Detailed touch mode guide (coming soon)

### Development Documentation
- **CLAUDE.md**: Development guide for contributors (git tracked)
- **DYNAMIC_MEMORY_OPTIMIZATION.md**: Memory architecture notes (local only)

## ‚ö†Ô∏è Known Issues & Limitations

### Touch Mode
1. **Display Settings Limited**: Only max layers adjustable in v2.0
2. **No Persistence**: Settings reset on power cycle (will be added in v2.1)
3. **Gesture Sensitivity**: May need adjustment for different environments

### General
1. **Multi-Keyboard Limit**: Maximum 5 keyboards (protocol limitation)
2. **Layer Range**: 0-9 layers supported (10 total)
3. **Battery Widget**: Requires battery hardware connected to XIAO BLE

### Workarounds
- **Settings Persistence**: Coming in v2.1 with NVS storage
- **More Gestures**: LEFT/RIGHT reserved for future brightness/contrast

## üôè Acknowledgments

### Issues Resolved
- **GitHub Issue #1**: Touch panel support request
- **GitHub Issue #5**: USB connection display fix

### Technical Inspirations
- **YADS (Yet Another Dongle Screen)**: UI widget designs and modifier symbols
- **ZMK Event System**: Thread-safe architecture patterns
- **LVGL Dynamic Allocation**: Memory-efficient UI management

### Community Testing
- Early adopters who reported APDS9960 blocking issues
- Touch mode testers who helped refine gesture recognition

## üìà Statistics

- **Commits**: 50+ commits across v2.0 development
- **Files Changed**: 15 new/modified source files
- **Code Added**: ~3,000 lines (touch support + improvements)
- **Code Removed**: ~64,000 lines (prospector_adapter legacy removal)
- **Build Size**:
  - Non-touch: ~900KB
  - Touch: ~920KB (+20KB for touch code)

## üîÆ What's Next?

### Planned for v2.1
1. **Settings Persistence**: NVS storage for Display Settings
2. **More Settings**: Brightness, contrast, color schemes
3. **LEFT/RIGHT Gestures**: Quick brightness adjustment
4. **Battery Optimization**: Enhanced power management for touch scanning

### Under Investigation
1. **Custom Widgets**: User-configurable widget layout
2. **Multiple Screens**: Swipe between different information views
3. **Haptic Feedback**: Touch confirmation via display backlight pulse

---

**Full Changelog**: [v1.1.1...v2.0.0](https://github.com/t-ogura/prospector-zmk-module/compare/v1.1.1...v2.0.0)

**Download Firmware**: [GitHub Actions Builds](https://github.com/t-ogura/zmk-config-prospector/actions)
