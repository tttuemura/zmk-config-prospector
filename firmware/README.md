# Prospector Scanner Test Firmwares

## 🧪 テスト用ファームウェアバリアント (2025-11-17)

このディレクトリには、バッテリー機能と環境光センサーの組み合わせテスト用に4つのファームウェアバリアントが含まれています。

## 📦 ファームウェアバリアント一覧

### 1. `prospector_scanner_battery-ON_sensor-ON.uf2` (912KB)
**設定**:
- ✅ バッテリーサポート: 有効
- ✅ 環境光センサー: 有効

**期待される動作**:
- スキャナー自身のバッテリー残量が右上に表示される
- APDS9960センサーによる自動輝度調整が動作する
- 環境光に応じて画面の明るさが変化する
- バッテリーハードウェアが必要（なければUSB-onlyモードで動作）
- センサーハードウェアが必要（なければ固定輝度にフォールバック）

**テスト項目**:
- [ ] バッテリーウィジェット表示（右上）
- [ ] USB接続時の充電アイコン
- [ ] 環境光変化での輝度変更
- [ ] スムーズな輝度フェード（800ms）

---

### 2. `prospector_scanner_battery-ON_sensor-OFF.uf2` (904KB)
**設定**:
- ✅ バッテリーサポート: 有効
- ❌ 環境光センサー: 無効

**期待される動作**:
- スキャナー自身のバッテリー残量が右上に表示される
- 固定輝度65%で動作
- バッテリーハードウェアが必要（なければUSB-onlyモードで動作）
- センサーハードウェア不要

**テスト項目**:
- [ ] バッテリーウィジェット表示（右上）
- [ ] USB接続時の充電アイコン
- [ ] 固定輝度65%で動作
- [ ] センサーなしでも起動成功

**重要**: このバリアントが今回の修正の主要テスト対象です（commit 96dde63）

---

### 3. `prospector_scanner_battery-OFF_sensor-ON.uf2` (898KB)
**設定**:
- ❌ バッテリーサポート: 無効
- ✅ 環境光センサー: 有効

**期待される動作**:
- スキャナー自身のバッテリー表示なし
- APDS9960センサーによる自動輝度調整が動作する
- 環境光に応じて画面の明るさが変化する
- バッテリーハードウェア不要
- センサーハードウェアが必要（なければ固定輝度にフォールバック）

**テスト項目**:
- [ ] バッテリーウィジェット非表示
- [ ] 環境光変化での輝度変更
- [ ] スムーズな輝度フェード（800ms）
- [ ] バッテリーなしでも起動成功

---

### 4. `prospector_scanner_battery-OFF_sensor-OFF.uf2` (891KB)
**設定**:
- ❌ バッテリーサポート: 無効
- ❌ 環境光センサー: 無効

**期待される動作**:
- スキャナー自身のバッテリー表示なし
- 固定輝度65%で動作
- バッテリーハードウェア不要
- センサーハードウェア不要
- **最小構成・最軽量**

**テスト項目**:
- [ ] バッテリーウィジェット非表示
- [ ] 固定輝度65%で動作
- [ ] 完全にハードウェア不要で動作
- [ ] 起動の安定性

---

## 🔧 ビルド情報

**ビルド日時**: 2025-11-17
**ベースコミット**: `96dde63` (fix/sensor-disabled-battery-crash)
**修正内容**: バッテリーサポート有効時のセンサー無効化クラッシュ修正

**主要変更点**:
1. I2CとSENSORサブシステムを常に有効化（バッテリーサポート用）
2. APDS9960ドライバは環境光センサー有効時のみ
3. seeeduino_xiao_ble.overlayにI2C Device Tree追加
4. brightness_control.c の brightness=0 フォールバック修正

---

## 📋 テスト手順

### 基本テスト
1. 各ファームウェアをSeeeduino XIAO BLEにフラッシュ
2. USB接続して起動確認
3. キーボードからのBLE Advertisement受信確認

### ハードウェア別テスト

#### バッテリーテスト（Variant 1, 2）
- USB接続のみ: バッテリーウィジェットに「⚡ USB」アイコン表示
- バッテリー接続: 実際のバッテリー残量パーセント表示
- バッテリー充電中: 充電アイコンとパーセント表示

#### センサーテスト（Variant 1, 3）
- センサー接続あり: 環境光に応じた輝度変化
- センサー接続なし: 固定輝度65%にフォールバック
- フェード動作: 800ms/12ステップのスムーズ変化

---

## ⚠️ 既知の問題

### 正常な警告（無視してOK）
```
warning: 'process_advertisement' defined but not used
warning: 'find_keyboard_by_id' defined but not used
warning: unused variable 'zmk_cached'
```
これらはコンパイル時の最適化による未使用コード警告です。動作には影響ありません。

---

## 🎯 テスト成功基準

### Variant 1 (Battery ON + Sensor ON)
- ✅ 起動成功（クラッシュなし）
- ✅ バッテリーウィジェット表示
- ✅ 環境光による輝度変化

### Variant 2 (Battery ON + Sensor OFF) ⭐ 最重要
- ✅ 起動成功（クラッシュなし）
- ✅ バッテリーウィジェット表示
- ✅ 固定輝度65%で動作
- ✅ センサーハードウェア不要

### Variant 3 (Battery OFF + Sensor ON)
- ✅ 起動成功（クラッシュなし）
- ✅ バッテリーウィジェット非表示
- ✅ 環境光による輝度変化

### Variant 4 (Battery OFF + Sensor OFF)
- ✅ 起動成功（クラッシュなし）
- ✅ バッテリーウィジェット非表示
- ✅ 固定輝度65%で動作
- ✅ 完全にハードウェア不要

---

## 📞 問題報告

テスト中に問題が見つかった場合:
1. どのバリアント（1-4）で発生したか
2. ハードウェア構成（バッテリー/センサーの有無）
3. 症状（クラッシュ、表示異常、動作不良など）
4. 再現手順

を記録してください。

---

**Generated by**: Claude Code
**Build Branch**: fix/sensor-disabled-battery-crash
**Test Purpose**: バッテリーウィジェット + 環境光センサーの全組み合わせテスト
